name: CI/CD â€” Production

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: "20"
  JAVA_VERSION: "17"
  APP_DIR: ${{ vars.APP_DIR || '/app' }}
  BACKEND_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/pixelism-shop-backend:latest
  FRONTEND_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/pixelism-shop-frontend:latest
  BACKEND_PORT: ${{ vars.BACKEND_PORT || '8080' }}
  FRONTEND_PORT: ${{ vars.FRONTEND_PORT || '3000' }}
  CI_API_URL: http://localhost:8080/api/v1
  CI_BACKEND_URL: http://localhost:8080

jobs:
  frontend:
    name: Frontend CI
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./client-shop

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: ./client-shop/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Build
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: ${{ env.CI_API_URL }}
          NEXT_PUBLIC_BACKEND_URL: ${{ env.CI_BACKEND_URL }}

  backend:
    name: Backend CI
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./shop

    steps:
      - uses: actions/checkout@v4

      - name: Setup Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: temurin
          cache: maven

      - name: Build (skip tests)
        run: mvn clean install -DskipTests

  docker-validate:
    name: Validate Dockerfiles
    runs-on: ubuntu-latest
    needs: [frontend, backend]

    steps:
      - uses: actions/checkout@v4

      - name: Build backend image
        run: docker build -t backend:ci-test ./shop

      - name: Build frontend image
        run: |
          docker build \
            --build-arg NEXT_PUBLIC_API_URL="${{ env.CI_API_URL }}" \
            --build-arg NEXT_PUBLIC_BACKEND_URL="${{ env.CI_BACKEND_URL }}" \
            -t frontend:ci-test \
            ./client-shop

  # Deploy only on push to main (not on PRs)
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    environment: production
    needs: [docker-validate]
    if: github.event_name == 'push'

    steps:
      - uses: actions/checkout@v4

      - name: Login to Docker Hub
        run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Build & Push Backend
        run: |
          docker build -t ${{ env.BACKEND_IMAGE }} ./shop
          docker push ${{ env.BACKEND_IMAGE }}

      - name: Build & Push Frontend
        run: |
          docker build \
            --build-arg NEXT_PUBLIC_API_URL=https://${{ secrets.EC2_HOST }}/api/v1 \
            --build-arg NEXT_PUBLIC_BACKEND_URL=https://${{ secrets.EC2_HOST }} \
            -t ${{ env.FRONTEND_IMAGE }} \
            ./client-shop
          docker push ${{ env.FRONTEND_IMAGE }}

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Trust EC2 host
        run: |
          mkdir -p ~/.ssh && chmod 700 ~/.ssh
          ssh-keyscan -H "${{ secrets.EC2_HOST }}" >> ~/.ssh/known_hosts 2>/dev/null

      - name: Build .env
        run: |
          printf '%s\n' \
            "BACKEND_IMAGE=${{ env.BACKEND_IMAGE }}" \
            "FRONTEND_IMAGE=${{ env.FRONTEND_IMAGE }}" \
            "BACKEND_PORT=${{ env.BACKEND_PORT }}" \
            "FRONTEND_PORT=${{ env.FRONTEND_PORT }}" \
            "COMPOSE_PROJECT_NAME=pixelism" \
            "DB_HOST=${{ secrets.DB_HOST }}" \
            "DB_PORT=${{ secrets.DB_PORT }}" \
            "DB_NAME=${{ secrets.DB_NAME }}" \
            "DB_USER=${{ secrets.DB_USER }}" \
            "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" \
            "REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}" \
            "JWT_SECRET=${{ secrets.JWT_SECRET }}" \
            "JWT_ACCESS_EXPIRATION=${{ secrets.JWT_ACCESS_EXPIRATION }}" \
            "JWT_REFRESH_EXPIRATION=${{ secrets.JWT_REFRESH_EXPIRATION }}" \
            "OTP_EXPIRATION=${{ secrets.OTP_EXPIRATION }}" \
            "OTP_LENGTH=${{ secrets.OTP_LENGTH }}" \
            "MAIL_USERNAME=${{ secrets.MAIL_USERNAME }}" \
            "MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}" \
            "FRONTEND_REDIRECT_URI=${{ secrets.FRONTEND_REDIRECT_URI }}" \
            "OAUTH2_REDIRECT_BASE_URI=${{ secrets.OAUTH2_REDIRECT_BASE_URI }}" \
            "CLIENT_ID_GOOGLE=${{ secrets.CLIENT_ID_GOOGLE }}" \
            "CLIENT_SECRET_GOOGLE=${{ secrets.CLIENT_SECRET_GOOGLE }}" \
            "CLIENT_ID_GITHUB=${{ secrets.CLIENT_ID_GITHUB }}" \
            "CLIENT_SECRET_GITHUB=${{ secrets.CLIENT_SECRET_GITHUB }}" \
            "CLOUDINARY_CLOUD_NAME=${{ secrets.CLOUDINARY_CLOUD_NAME }}" \
            "CLOUDINARY_API_KEY=${{ secrets.CLOUDINARY_API_KEY }}" \
            "CLOUDINARY_API_SECRET=${{ secrets.CLOUDINARY_API_SECRET }}" \
            > /tmp/app.env

      - name: Upload .env to EC2
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "mkdir -p ${{ env.APP_DIR }}"
          scp /tmp/app.env ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:${{ env.APP_DIR }}/.env

      - name: Deploy on EC2
        env:
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
          APP_DIR: ${{ env.APP_DIR }}
        run: |
          ssh -o ServerAliveInterval=60 ${EC2_USER}@${EC2_HOST} \
            APP_DIR="${APP_DIR}" \
            DOCKERHUB_USERNAME="${DOCKERHUB_USERNAME}" \
            DOCKERHUB_TOKEN="${DOCKERHUB_TOKEN}" \
            bash -s << 'ENDSSH'
            set -e
            cd "${APP_DIR}"
            echo "${DOCKERHUB_TOKEN}" | docker login -u "${DOCKERHUB_USERNAME}" --password-stdin
            docker compose --env-file .env pull
            docker compose --env-file .env up -d --remove-orphans --force-recreate
            docker image prune -f
            echo "Deploy complete."
          ENDSSH

      - name: Health Check
        run: |
          echo "Waiting 30s for services to start..."
          sleep 30
          curl --fail --retry 5 --retry-delay 10 --retry-connrefused --max-time 10 \
            https://pixelism.duckdns.org/actuator/health && echo "Backend OK" \
            || { echo "ERROR: Backend health check failed"; exit 1; }
          curl --fail --retry 3 --retry-delay 5 --max-time 10 \
            https://pixelism.duckdns.org && echo "Frontend OK" \
            || { echo "ERROR: Frontend health check failed"; exit 1; }

      - name: Summary
        if: always()
        run: |
          echo "Status : ${{ job.status }}"
          echo "Commit : ${{ github.sha }}"
          echo "Actor  : ${{ github.actor }}"
          echo "Time   : $(date '+%Y-%m-%d %H:%M:%S UTC')"